openapi: 3.1.0
info:
  title: AI-DB API
  version: 0.1.0
  description: API for NL-to-SQL reporting with multi-DB and multi-LLM support.
servers:
  - url: /
    description: Local runtime (same origin)
tags:
  - name: Query
  - name: Export
  - name: Admin
  - name: Providers
  - name: Observability
paths:
  /v1/query/sessions:
    post:
      tags: [Query]
      summary: Create a query session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSessionRequest"
      responses:
        "201":
          description: Session created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateSessionResponse"
  /v1/query/sessions/{sessionId}/run:
    post:
      tags: [Query]
      summary: Generate SQL and execute a query session
      parameters:
        - $ref: "#/components/parameters/SessionId"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RunSessionRequest"
      responses:
        "200":
          description: Query executed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunSessionResponse"
  /v1/query/sessions/{sessionId}/feedback:
    post:
      tags: [Query]
      summary: Submit feedback for a query session
      parameters:
        - $ref: "#/components/parameters/SessionId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FeedbackRequest"
      responses:
        "200":
          description: Feedback stored
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OkResponse"
  /v1/query/sessions/{sessionId}/export:
    post:
      tags: [Export]
      summary: Download query results in selected format
      parameters:
        - $ref: "#/components/parameters/SessionId"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExportRequest"
      responses:
        "200":
          description: Export file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "400":
          description: Unsupported format
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  message:
                    type: string
                required: [error]
        "404":
          description: Session not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  message:
                    type: string
                required: [error, message]
  /v1/query/sessions/{sessionId}/export/deliver:
    post:
      tags: [Export]
      summary: Deliver an export via download or email
      parameters:
        - $ref: "#/components/parameters/SessionId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExportDeliverRequest"
      responses:
        "200":
          description: Download file (when delivery_mode is download)
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
          headers:
            x-export-id:
              schema:
                type: string
              description: Export delivery tracking ID
        "202":
          description: Email delivery accepted (async)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExportDeliverAccepted"
  /v1/exports/{exportId}/status:
    get:
      tags: [Export]
      summary: Check export delivery status
      parameters:
        - in: path
          name: exportId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Delivery status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExportDeliveryStatus"
        "404":
          description: Export delivery not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  message:
                    type: string
                required: [error, message]
  /v1/data-sources:
    get:
      tags: [Admin]
      summary: List registered data sources
      responses:
        "200":
          description: Data source list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DataSourceListResponse"
    post:
      tags: [Admin]
      summary: Register a data source
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateDataSourceRequest"
      responses:
        "201":
          description: Data source created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DataSourceResponse"
  /v1/data-sources/{dataSourceId}:
    delete:
      tags: [Admin]
      summary: Delete a data source and its dependent data
      parameters:
        - $ref: "#/components/parameters/DataSourceId"
      responses:
        "200":
          description: Data source deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OkResponse"
        "404":
          description: Data source not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  message:
                    type: string
                required: [error, message]
  /v1/data-sources/{dataSourceId}/introspect:
    post:
      tags: [Admin]
      summary: Introspect schema metadata for a data source
      parameters:
        - $ref: "#/components/parameters/DataSourceId"
      responses:
        "202":
          description: Introspection job started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobAcceptedResponse"
  /v1/schema-objects:
    get:
      tags: [Admin]
      summary: List schema objects for a data source
      parameters:
        - in: query
          name: data_source_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Schema objects
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/SchemaObject"
                required: [items]
  /v1/semantic-entities:
    post:
      tags: [Admin]
      summary: Create or update semantic entity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SemanticEntityRequest"
      responses:
        "200":
          description: Semantic entity upserted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SemanticEntityResponse"
  /v1/metric-definitions:
    post:
      tags: [Admin]
      summary: Create or update metric definition
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MetricDefinitionRequest"
      responses:
        "200":
          description: Metric definition upserted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MetricDefinitionResponse"
  /v1/join-policies:
    post:
      tags: [Admin]
      summary: Create or update join policy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/JoinPolicyRequest"
      responses:
        "200":
          description: Join policy upserted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JoinPolicyResponse"
  /v1/rag/reindex:
    post:
      tags: [Admin]
      summary: Trigger reindex for RAG documents
      parameters:
        - in: query
          name: data_source_id
          required: true
          schema:
            type: string
      responses:
        "202":
          description: Reindex job started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobAcceptedResponse"
  /v1/llm/providers:
    get:
      tags: [Providers]
      summary: List configured LLM providers
      responses:
        "200":
          description: Provider configs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LlmProviderListResponse"
    post:
      tags: [Providers]
      summary: Register or update an LLM provider config
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LlmProviderRequest"
      responses:
        "200":
          description: Provider config upserted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LlmProviderResponse"
  /v1/llm/routing-rules:
    post:
      tags: [Providers]
      summary: Configure provider routing policy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RoutingRuleRequest"
      responses:
        "200":
          description: Routing rule upserted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RoutingRuleResponse"
  /v1/health/providers:
    get:
      tags: [Providers]
      summary: Provider health status
      responses:
        "200":
          description: Health status
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        provider:
                          type: string
                        status:
                          type: string
                          enum: [healthy, degraded, down]
                        checked_at:
                          type: string
                          format: date-time
                      required: [provider, status, checked_at]
                required: [items]
  /v1/observability/metrics:
    get:
      tags: [Observability]
      summary: Aggregated observability metrics over a time window
      parameters:
        - in: query
          name: window_hours
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 720
      responses:
        "200":
          description: Metrics snapshot
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ObservabilityMetricsResponse"
  /v1/observability/release-gates:
    get:
      tags: [Observability]
      summary: Latest benchmark release-gate outcome
      responses:
        "200":
          description: Latest benchmark release gate status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReleaseGatesResponse"
        "404":
          description: No benchmark report found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  message:
                    type: string
                required: [error, message]
  /v1/observability/release-gates/report:
    post:
      tags: [Observability]
      summary: Persist a benchmark report for release-gate tracking
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BenchmarkReportUploadRequest"
      responses:
        "201":
          description: Benchmark report stored
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  created_at:
                    type: string
                    format: date-time
                required: [id, created_at]
components:
  parameters:
    SessionId:
      in: path
      name: sessionId
      required: true
      schema:
        type: string
    DataSourceId:
      in: path
      name: dataSourceId
      required: true
      schema:
        type: string
  schemas:
    CreateSessionRequest:
      type: object
      properties:
        data_source_id:
          type: string
        question:
          type: string
      required: [data_source_id, question]
    CreateSessionResponse:
      type: object
      properties:
        session_id:
          type: string
        status:
          type: string
          enum: [created]
      required: [session_id, status]
    RunSessionRequest:
      type: object
      properties:
        llm_provider:
          type: string
          enum: [openai, gemini, deepseek]
        model:
          type: string
        max_rows:
          type: integer
          minimum: 1
          maximum: 100000
        timeout_ms:
          type: integer
          minimum: 1000
          maximum: 120000
    RunSessionResponse:
      type: object
      properties:
        attempt_id:
          type: string
        sql:
          type: string
        columns:
          type: array
          items:
            type: string
        rows:
          type: array
          items:
            type: object
            additionalProperties: true
        row_count:
          type: integer
        duration_ms:
          type: integer
        confidence:
          type: number
      required: [attempt_id, sql, columns, rows, row_count, duration_ms, confidence]
    FeedbackRequest:
      type: object
      properties:
        rating:
          type: integer
          minimum: 1
          maximum: 5
        corrected_sql:
          type: string
        comment:
          type: string
      required: [rating]
    OkResponse:
      type: object
      properties:
        ok:
          type: boolean
      required: [ok]
    CreateDataSourceRequest:
      type: object
      properties:
        name:
          type: string
        db_type:
          type: string
          enum: [postgres]
        connection_ref:
          type: string
      required: [name, db_type, connection_ref]
    DataSourceResponse:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        db_type:
          type: string
        status:
          type: string
      required: [id, name, db_type, status]
    DataSourceListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              db_type:
                type: string
              connection_ref:
                type: string
              status:
                type: string
              created_at:
                type: string
                format: date-time
            required: [id, name, db_type, connection_ref, status, created_at]
      required: [items]
    JobAcceptedResponse:
      type: object
      properties:
        job_id:
          type: string
        status:
          type: string
          enum: [queued]
      required: [job_id, status]
    SchemaObject:
      type: object
      properties:
        id:
          type: string
        object_type:
          type: string
          enum: [table, view, materialized_view]
        schema_name:
          type: string
        object_name:
          type: string
        description:
          type: string
      required: [id, object_type, schema_name, object_name]
    SemanticEntityRequest:
      type: object
      properties:
        data_source_id:
          type: string
        entity_type:
          type: string
          enum: [table, column, metric, dimension, rule]
        target_ref:
          type: string
        business_name:
          type: string
        description:
          type: string
      required: [data_source_id, entity_type, target_ref, business_name]
    SemanticEntityResponse:
      type: object
      properties:
        id:
          type: string
        active:
          type: boolean
      required: [id, active]
    MetricDefinitionRequest:
      type: object
      properties:
        semantic_entity_id:
          type: string
        sql_expression:
          type: string
        grain:
          type: string
      required: [semantic_entity_id, sql_expression]
    MetricDefinitionResponse:
      type: object
      properties:
        id:
          type: string
      required: [id]
    JoinPolicyRequest:
      type: object
      properties:
        data_source_id:
          type: string
        left_ref:
          type: string
        right_ref:
          type: string
        join_type:
          type: string
        on_clause:
          type: string
        approved:
          type: boolean
      required: [data_source_id, left_ref, right_ref, join_type, on_clause, approved]
    JoinPolicyResponse:
      type: object
      properties:
        id:
          type: string
      required: [id]
    LlmProviderRequest:
      type: object
      properties:
        provider:
          type: string
          enum: [openai, gemini, deepseek]
        api_key_ref:
          type: string
        default_model:
          type: string
        enabled:
          type: boolean
      required: [provider, api_key_ref, default_model, enabled]
    LlmProviderResponse:
      type: object
      properties:
        provider:
          type: string
        enabled:
          type: boolean
      required: [provider, enabled]
    LlmProviderListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              provider:
                type: string
                enum: [openai, gemini, deepseek]
              default_model:
                type: string
              enabled:
                type: boolean
              created_at:
                type: string
                format: date-time
              updated_at:
                type: string
                format: date-time
            required: [id, provider, default_model, enabled, created_at, updated_at]
      required: [items]
    RoutingRuleRequest:
      type: object
      properties:
        data_source_id:
          type: string
        primary_provider:
          type: string
          enum: [openai, gemini, deepseek]
        fallback_providers:
          type: array
          items:
            type: string
            enum: [openai, gemini, deepseek]
        strategy:
          type: string
          enum: [ordered_fallback, cost_optimized, latency_optimized]
      required: [data_source_id, primary_provider, fallback_providers, strategy]
    RoutingRuleResponse:
      type: object
      properties:
        id:
          type: string
      required: [id]
    ObservabilityMetricsResponse:
      type: object
      additionalProperties: true
    ReleaseGatesResponse:
      type: object
      additionalProperties: true
    BenchmarkReportUploadRequest:
      type: object
      properties:
        run_date:
          type: string
          format: date-time
        dataset_file:
          type: string
        data_source_id:
          type: string
        provider:
          type: string
        model:
          type: string
        summary:
          type: object
          additionalProperties: true
      required: [run_date, dataset_file, summary]
    ExportRequest:
      type: object
      properties:
        format:
          type: string
          enum: [json, csv, xlsx, tsv, parquet]
          default: json
    ExportDeliverRequest:
      type: object
      properties:
        delivery_mode:
          type: string
          enum: [download, email]
        format:
          type: string
          enum: [json, csv, xlsx, tsv, parquet]
          default: json
        recipients:
          type: array
          items:
            type: string
            format: email
          description: Required when delivery_mode is email
      required: [delivery_mode]
    ExportDeliverAccepted:
      type: object
      properties:
        export_id:
          type: string
        status:
          type: string
          enum: [processing]
        delivery_mode:
          type: string
          enum: [email]
      required: [export_id, status, delivery_mode]
    ExportDeliveryStatus:
      type: object
      properties:
        id:
          type: string
        session_id:
          type: string
        delivery_mode:
          type: string
          enum: [download, email]
        format:
          type: string
          enum: [json, csv, xlsx, tsv, parquet]
        recipients:
          type: array
          items:
            type: string
        status:
          type: string
          enum: [pending, processing, completed, failed]
        error_message:
          type: string
          nullable: true
        file_name:
          type: string
          nullable: true
        file_size_bytes:
          type: integer
          nullable: true
        requested_by:
          type: string
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
      required: [id, session_id, delivery_mode, format, status, requested_by, created_at]
